<!-- ── PAGE HEADER ─────────────────────────────────────────── -->
<div class="page-header">
  <div>
    <div class="page-title">
      <span class="material-symbols-outlined title-icon">
        {{ role === 'technicien' ? 'agriculture' : role === 'cooperative' ? 'groups' : 'admin_panel_settings' }}
      </span>
      {{ role === 'technicien' ? 'Gestion Agricole' : role === 'cooperative' ? 'Coopérative Agricole' : 'Administration Agricole' }}
    </div>
    <div class="page-subtitle">
      {{ role === 'technicien' ? 'Vos parcelles et suivi terrain' :
         role === 'cooperative' ? 'Vue d\'ensemble de vos membres et parcelles' :
         'Configuration et gestion globale du système' }}
    </div>
  </div>
  <div class="page-actions">
    <button class="ghost-btn" (click)="chargerDonnees()">
      <span class="material-symbols-outlined">refresh</span> Actualiser
    </button>
    <button class="primary-btn" *ngIf="role === 'admin'" (click)="ouvrirSeuilModal()">
      <span class="material-symbols-outlined">add</span> Nouveau Seuil
    </button>
  </div>
</div>

<!-- ── KPI CARDS ───────────────────────────────────────────── -->
<div class="grid-4">
  <app-kpi-card *ngFor="let kpi of kpis" [item]="kpi"></app-kpi-card>
</div>

<!-- ════════════════════════════════════════════════════════════
     VUE TECHNICIEN
     ════════════════════════════════════════════════════════════ -->
<ng-container *ngIf="role === 'technicien'">

  <!-- Filtres -->
  <div class="filters-bar section-gap">
    <div class="search-input">
      <span class="material-symbols-outlined">search</span>
      <input [(ngModel)]="filtreRecherche" placeholder="Rechercher une parcelle ou culture..." />
    </div>
    <div class="filter-tabs">
      <button [class.active]="filtreStatut==='tous'" (click)="filtreStatut='tous'">Toutes</button>
      <button [class.active]="filtreStatut==='active'" (click)="filtreStatut='active'">Actives</button>
      <button [class.active]="filtreStatut==='alerte'" (click)="filtreStatut='alerte'">Alertes</button>
      <button [class.active]="filtreStatut==='inactive'" (click)="filtreStatut='inactive'">Inactives</button>
    </div>
  </div>

  <!-- Liste parcelles -->
  <div class="grid-2 section-gap">
    <div *ngFor="let p of parcellesFiltrees" class="card parcelle-card" [class]="'border-'+p.statut">
      <div class="parcelle-header">
        <div>
          <div class="card-title">{{ p.nom }}</div>
          <div class="stat-label">{{ p.localisation }}</div>
        </div>
        <span class="status-badge" [class]="p.statut">{{ statutLabel(p.statut) }}</span>
      </div>
      <div class="parcelle-meta">
        <div class="meta-item">
          <span class="material-symbols-outlined">eco</span>
          <span>{{ p.culture }}</span>
        </div>
        <div class="meta-item">
          <span class="material-symbols-outlined">straighten</span>
          <span>{{ p.superficie }} ha</span>
        </div>
        <div class="meta-item">
          <span class="material-symbols-outlined">sensors</span>
          <span>{{ p.noeudsIds.length }} capteur(s)</span>
        </div>
      </div>
    </div>
    <div *ngIf="parcellesFiltrees.length === 0" class="card empty-state">
      <span class="material-symbols-outlined">search_off</span>
      <p>Aucune parcelle trouvée</p>
    </div>
  </div>

  <!-- Alertes actives -->
  <div class="section-gap">
    <div class="card">
      <div class="card-title">
        <span class="material-symbols-outlined">notifications_active</span>
        Alertes Actives
      </div>
      <div class="list">
        <div *ngFor="let a of alertes" class="list-item alerte-item" [class]="a.niveau" [class.traitee]="a.traitee">
          <div class="alerte-left">
            <span class="material-symbols-outlined alerte-icon">{{ niveauIcon(a.niveau) }}</span>
            <div>
              <div class="alerte-titre">{{ a.type }} — {{ a.parcelle }}</div>
              <div class="stat-label">{{ a.message }}</div>
            </div>
          </div>
          <div class="alerte-right">
            <span class="stat-label">{{ a.timestamp | date:'HH:mm' }}</span>
            <button *ngIf="!a.traitee" class="ghost-btn small" (click)="marquerTraitee(a.id)">
              <span class="material-symbols-outlined">check</span>
            </button>
            <span *ngIf="a.traitee" class="tag">Traitée</span>
          </div>
        </div>
      </div>
    </div>
  </div>

</ng-container>

<!-- ════════════════════════════════════════════════════════════
     VUE COOPÉRATIVE
     ════════════════════════════════════════════════════════════ -->
<ng-container *ngIf="role === 'cooperative'">

  <!-- Recherche membres -->
  <div class="filters-bar section-gap">
    <div class="search-input">
      <span class="material-symbols-outlined">search</span>
      <input [(ngModel)]="filtreRecherche" placeholder="Rechercher un membre..." />
    </div>
  </div>

  <!-- Tableau membres -->
  <div class="card section-gap">
    <div class="card-title">
      <span class="material-symbols-outlined">group</span> Membres de la Coopérative
    </div>
    <div class="table-wrapper">
      <table class="agri-table">
        <thead>
          <tr>
            <th>Membre</th>
            <th>Téléphone</th>
            <th>Parcelles</th>
            <th>Superficie</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of membresFiltres">
            <td>
              <div class="membre-nom">{{ m.prenom }} {{ m.nom }}</div>
            </td>
            <td class="stat-label">{{ m.telephone }}</td>
            <td>{{ m.parcelles }}</td>
            <td>{{ m.superficie }} ha</td>
            <td><span class="status-badge" [class]="m.statut">{{ statutLabel(m.statut) }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Vue parcelles globales -->
  <div class="grid-2 section-gap">
    <div *ngFor="let p of parcellesFiltrees" class="card parcelle-card" [class]="'border-'+p.statut">
      <div class="parcelle-header">
        <div>
          <div class="card-title">{{ p.nom }}</div>
          <div class="stat-label">{{ p.culture }} · {{ p.superficie }} ha</div>
        </div>
        <span class="status-badge" [class]="p.statut">{{ statutLabel(p.statut) }}</span>
      </div>
      <div class="parcelle-meta">
        <div class="meta-item">
          <span class="material-symbols-outlined">location_on</span>
          <span>{{ p.localisation }}</span>
        </div>
        <div class="meta-item">
          <span class="material-symbols-outlined">sensors</span>
          <span>{{ p.noeudsIds.length }} nœud(s)</span>
        </div>
      </div>
    </div>
  </div>

</ng-container>

<!-- ════════════════════════════════════════════════════════════
     VUE ADMIN
     ════════════════════════════════════════════════════════════ -->
<ng-container *ngIf="role === 'admin'">

  <!-- Toutes parcelles avec gestion -->
  <div class="card section-gap">
    <div class="card-title">
      <span class="material-symbols-outlined">location_on</span> Toutes les Parcelles
    </div>
    <div class="table-wrapper">
      <table class="agri-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>Culture</th>
            <th>Superficie</th>
            <th>Nœuds</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of parcelles">
            <td class="stat-label mono">{{ p.id }}</td>
            <td><strong>{{ p.nom }}</strong></td>
            <td>{{ p.culture }}</td>
            <td>{{ p.superficie }} ha</td>
            <td>
              <span class="tag">{{ p.noeudsIds.length }}</span>
            </td>
            <td><span class="status-badge" [class]="p.statut">{{ statutLabel(p.statut) }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Config seuils d'alerte -->
  <div class="card section-gap">
    <div class="seuils-header">
      <div class="card-title">
        <span class="material-symbols-outlined">tune</span> Configuration des Seuils d'Alerte
      </div>
      <button class="primary-btn small" (click)="ouvrirSeuilModal()">
        <span class="material-symbols-outlined">add</span> Ajouter
      </button>
    </div>
    <div class="list">
      <div *ngFor="let s of seuils" class="list-item seuil-item">
        <div class="seuil-left">
          <span class="material-symbols-outlined">sensors</span>
          <div>
            <div class="seuil-titre">{{ s.noeudId }} — {{ s.type }}</div>
            <div class="stat-label">Min : {{ s.min }} · Max : {{ s.max }}</div>
          </div>
        </div>
        <div class="seuil-right">
          <span class="status-badge" [class]="s.actif ? 'active' : 'inactive'">
            {{ s.actif ? 'Actif' : 'Inactif' }}
          </span>
          <button class="ghost-btn small" (click)="ouvrirSeuilModal(s)">
            <span class="material-symbols-outlined">edit</span>
          </button>
        </div>
      </div>
    </div>
  </div>

</ng-container>

<!-- ── MODAL SEUIL (Admin) ─────────────────────────────────── -->
<div class="modal-overlay" *ngIf="showSeuilModal" (click)="showSeuilModal=false">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="card-title">Configurer un Seuil</div>
      <button class="ghost-btn small" (click)="showSeuilModal=false">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-body">
      <label>Nœud ID
        <input [(ngModel)]="seuilEdite.noeudId" placeholder="NODE_A3_01" class="form-input" />
      </label>
      <label>Type de mesure
        <select [(ngModel)]="seuilEdite.type" class="form-input">
          <option value="hum_sol">Humidité Sol</option>
          <option value="temp_sol">Température Sol</option>
          <option value="temp_air">Température Air</option>
          <option value="hum_air">Humidité Air</option>
          <option value="pluie_mm">Pluviométrie</option>
        </select>
      </label>
      <div class="grid-2">
        <label>Minimum
          <input type="number" [(ngModel)]="seuilEdite.min" class="form-input" />
        </label>
        <label>Maximum
          <input type="number" [(ngModel)]="seuilEdite.max" class="form-input" />
        </label>
      </div>
      <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="seuilEdite.actif" />
        Seuil actif
      </label>
    </div>
    <div class="modal-footer">
      <button class="ghost-btn" (click)="showSeuilModal=false">Annuler</button>
      <button class="primary-btn" (click)="sauvegarderSeuil()">
        <span class="material-symbols-outlined">save</span> Sauvegarder
      </button>
    </div>
  </div>
</div>